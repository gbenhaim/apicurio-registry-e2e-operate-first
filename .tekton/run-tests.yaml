---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: tests-pipeline-
spec:
  params:
    - name: git-url
      value: https://github.com/Apicurio/apicurio-registry-e2e-operate-first.git
    - name: revision
      value: main
  workspaces:
    - name: ws-pipeline
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 1Gi
  pipelineSpec:
    params:
      - name: git-url
        type: string
      - name: revision
        type: string
    workspaces:
      - name: ws-pipeline
    tasks:
      - name: clone-repository
        params:
          - name: url
            value: $(params.git-url)
          - name: revision
            value: $(params.revision)
        workspaces:
          - name: output
            workspace: ws-pipeline
            subPath: repo
        taskRef:
          bundle: quay.io/redhat-appstudio/appstudio-tasks:510fa6e99f1fa1f816c96354bbaf1ad155c6d9c3-1
          name: git-clone
      - name: chrome
        params:
          - name: projects
            value: "Google Chrome"
          - name: deps
            value: chrome
          - name: cred-secret-name
            value: operate-first-cred
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: repo
          - name: test-results-ws
            workspace: ws-pipeline
            subPath: tests-results/chrome
        runAfter:
          - clone-repository
        taskRef:
          name: run-playwright
      - name: edge
        params:
          - name: projects
            value: "Microsoft Edge"
          - name: deps
            value: msedge
          - name: cred-secret-name
            value: operate-first-cred
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: repo
          - name: test-results-ws
            workspace: ws-pipeline
            subPath: tests-results/edge
        runAfter:
          - clone-repository
        taskRef:
          name: run-playwright
      - name: firefox
        params:
          - name: projects
            value: firefox
          - name: deps
            value: firefox
          - name: cred-secret-name
            value: operate-first-cred
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: repo
          - name: test-results-ws
            workspace: ws-pipeline
            subPath: tests-results/firefox
        runAfter:
          - clone-repository
        taskRef:
          name: run-playwright
      - name: chromium
        params:
          - name: projects
            value: chromium
          - name: deps
            value: chromium
          - name: cred-secret-name
            value: operate-first-cred
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: repo
          - name: test-results-ws
            workspace: ws-pipeline
            subPath: tests-results/chromium
        runAfter:
          - clone-repository
        taskRef:
          name: run-playwright
      - name: webkit
        params:
          - name: projects
            value: webkit
          - name: deps
            value: webkit
          - name: cred-secret-name
            value: operate-first-cred
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: repo
          - name: test-results-ws
            workspace: ws-pipeline
            subPath: tests-results/webkit
        runAfter:
          - clone-repository
        taskRef:
          name: run-playwright
    finally:
      - name: report-results
        params:
          - name: pipeline-run-name
            value: $(context.pipelineRun.name)
        workspaces:
          - name: ws
            workspace: ws-pipeline
            subPath: tests-results
        taskSpec:
            params:
              - name: pipeline-run-name
            workspaces:
              - name: ws
            steps:
              - name: echo
                image: quay.io/gbenhaim0/rsync-image:latest
                script: |
                          echo "Uploading test logs"
                          rsync -av "$(workspaces.ws.path)/" rsync://${FILE_SERVER_PORT_873_TCP_ADDR}/files/$(params.pipeline-run-name)
